<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="~{layout/layout}">
    <th:block layout:fragment="content">
        <style>
            #msgArea li{
                list-style: none;
            }
            .chat-yellow {
                background: #FFEC46
            }
            .chat-username{
                font-weight: bold;
            }
            .chat-msg-box{
                border-radius: 5px;
                display: inline-block;
                padding: 5px;
            }
            .chat-enter-box{
                background: #ABBECF;
                text-align: center;
            }
            #msgArea{
                height: 500px;
                max-height: 500px;
                overflow-y: auto;
                padding: 20px;
            }
            .chat-date{
                margin: 5px;
                font-size: 12px;
                vertical-align: bottom;
            }
        </style>
        <script th:inline="javascript">
            $(document).ready(function(){
                $('#sendMsg').keydown((key)=>{
                    if(key.keyCode == 13){
                        fn_sendMsg();
                    }
                })
            })
            const userName = [[${#authentication.principal.username}]];
            let ws;
            let userStompClient;

            //채팅요청
            function fn_managerChat(){
                ws = new SockJS("/stomp/chat");
                userStompClient = Stomp.over(ws);
                userStompClient.connect({}, ()=>{
                    userStompClient.subscribe('/queue/'+userName,(frame)=>{
                        const info = JSON.parse(frame.body);
                        fn_chatMessage(info);
                    })
                    userStompClient.send('/topic/admin',{},JSON.stringify({sender:userName}));
                });
            }

            function fn_chatMessage(info){
                const msgForm = [];
                const date = new Date(info.timestamp);
                if(info.type == 'ENTER'){
                    msgForm.push("<div class='chat-enter-box mb-3'>"+info.message+"</div>");
                }else if(info.sender == userName){
                    msgForm.push("<ul class='text-right'>");
                    msgForm.push("  <li>");
                    msgForm.push(       "<span class='chat-date'>"+date.getHours() +":"+date.getMinutes()+"</span>");
                    msgForm.push(       "<span class='chat-msg-box chat-yellow'>"+ info.message.replace(/\n/g,'<br/>') +"</span>");
                    msgForm.push("  </li>");
                    msgForm.push("</ul>");
                }else{
                    msgForm.push("<ul>");
                    msgForm.push("  <li class='chat-username'>"+ name +"</li>");
                    msgForm.push("  <li>");
                    msgForm.push(       "<span class='chat-msg-box bg-white'>"+ info.message.replace(/\n/g,'<br/>') +"</span>");
                    msgForm.push(       "<span class='chat-date'>"+date.getHours() +":"+date.getMinutes()+"</span>");
                    msgForm.push("  </li>");
                    msgForm.push("</ul>");
                }

                $('#msgArea').append(msgForm.join(''));
            }

            function fn_sendMsg(){
                const msg = {
                    type: 'MESSAGE',
                    sender : userName,
                    message : $('#sendMsg').val()
                }
                userStompClient.send('/app/'+userName,{},JSON.stringify(msg));
            }
        </script>
        <div class="p-3 col-md-4" style="background:#B3C8DA">
            <table class="w-100">
                <tr>
                    <td>
                        <div id="msgArea" name="msgArea"></div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="input-group">
                            <textarea class="form-control" type="text" id="sendMsg" name="sendMsg" placeholder="메세지를 입력하세요."></textarea>
                            <button class="chat-yellow btn btn-sm float-end" onclick="fn_sendMsg()">
                                전송
                            </button>
                        </div>
                    </td>
                </tr>
            </table>
            <button class="btn btn-primary btn-sm" onclick="fn_managerChat()">관리자 채팅 요청</button>
        </div>
    </th:block>
</html>